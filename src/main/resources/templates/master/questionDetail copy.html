<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문의 답변 페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" >
    <link rel="stylesheet" href="../static/css/master.css" th:href="@{/css/master.css}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" ></script>
    <script>
        const submitReply = async () => {
        const comContent = document.querySelector('#comContent').value;

        if (comContent === '') {
            alert('답변을 입력하세요.');
            comContent.focus();
            return false;
        }

        let formData = new FormData(replyForm)
        await fetch('/master/reply?option=I', {
            method: 'POST',
            body: formData,
        }).then((response)=> response.json())
		    .then((data)=> {
                console.log(data);
	    }).catch((error) => {
			console.log("error = " + error);
			alert("시스템 장애로 댓글 등록이 실패했습니다.");
        });

        // 답변 내용을 readonly로 변경
        comContent.setAttribute('readonly', true);

        // "수정" 버튼 활성화
        document.querySelector('#editBtn').classList.remove('d-none');
        document.querySelector('#submitBtn').classList.add('d-none');
    }

        const enableEdit = () => {
            const comContent = document.querySelector('#comContent');

            // readonly 해제
            comContent.removeAttribute('readonly');

            // "답변 제출" 버튼 활성화
            document.querySelector('#submitBtn').classList.remove('d-none');
            document.querySelector('#editBtn').classList.add('d-none');
        };
        const updateReply = async () => {
            const comContent = document.querySelector('#comContent').value;
            const queSeqno = document.querySelector('#queSeqno').value;
            const option = "U";

            if (content === '') {
                alert('내용을 입력하세요.');
                content.focus();
                return false;
            }

            try {
                const response = await fetch('/master/reply?queSeqno=option=U', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json', 
                    },
                    body: JSON.stringify({
                        queSeqno: queSeqno,
                        comContent: comContent,
                    }),
                });

                if (response.ok) {
                    alert('답변이 성공적으로 수정되었습니다.');

                    // 다시 readonly로 변경
                    content.setAttribute('readonly', true);

                    // "수정" 버튼 활성화
                    document.querySelector('#editBtn').classList.remove('d-none');
                    document.querySelector('#submitBtn').classList.add('d-none');
                    window.location.reload();
                } else {
                    alert('답변 수정 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert("시스템 장애로 답변 수정이 실패했습니다.");
            }
        };

        const deleteQuestion = async () => {
            const queSeqno = document.querySelector('#queSeqno').value;

            if (!confirm('정말로 이 문의를 삭제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`/master/question/delete?queSeqno=${queSeqno}`, {
                    method: 'GET',
                });

                if (response.ok) {
                    const message = await response.text();
                    alert(message); // 성공 메시지 표시
                    window.location.href = '/master/question?page=1'; // 목록 페이지로 리다이렉트
                } else if (response.status === 404) {
                    alert('해당 문의를 찾을 수 없습니다.');
                } else if (response.status === 500) {
                    alert('문의 삭제 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('시스템 장애로 문의 삭제가 실패했습니다.');
            }
        };
    </script>
</head>
<body>

    <!-- 네비게이션 바 -->
    <div th:insert="~{layout/masterNav :: master-nav}"></div>

<div class="container mt-5">
    <h2>문의 답변 페이지</h2>

    <!-- 문의 정보 표시 -->
    <div class="card mb-4">
        <div class="card-body">
            <p class="card-text"><small class="text-muted">작성자: <span th:text="${question['email'].email}"></span></small></p>
            <p class="card-text"><small class="text-muted">작성일: <span th:text="${#temporals.format(question['queDate'], 'yyyy-MM-dd HH:mm')}"></span></small></p>
            <h5 class="card-title">문의 제목: <span th:text="${question['queTitle']}"></span></h5>
            <p class="card-text">문의 내용:</p>
            <p th:text="${question['queContent']}"></p>
        </div>
    </div>

    <!-- 첨부  -->
    <div th:if="${#lists.size(questionFiles) > 0}">
        <h5>첨부 파일</h5>
        <ul>
            <li th:each="file : ${questionFiles}">
                <a th:href="@{'/q_img/' + ${file.org_filename}}" target="_blank" th:text="${file.stored_filename}"></a>
            </li>
        </ul>
    </div>
    <div class="mb-3">
        <button type="button" class="btn btn-danger" onclick="deleteQuestion()">문의 삭제</button>
        <!-- 작성중 페이지로 돌아가기 버튼 -->
        <button type="button" class="btn btn-secondary" onclick='window.history.back()'>돌아가기</button>
    </div>

    <!-- 답변 작성 폼 -->
    <form id="replyForm" name="replyForm" method="post">
        <!-- 답변 입력란 -->
        <div class="mb-3">
            <label for="comContent" class="form-label">답변 내용:</label>
            <textarea class="form-control" id="comContent" name="comContent" rows="5"></textarea>
            <input type="hidden" id="queSeqno" name="queSeqno" th:value="${question['queSeqno']}">
            <input type="hidden" id="email" name="email" th:value="${question['email'].email}">
        </div>
        <div>
            <button id="submitBtn" type="button" class="btn btn-primary" onclick="submitReply()">답변 제출</button>
            <button id="editBtn" type="button" class="btn btn-secondary d-none" onclick="enableEdit()">수정</button>
        </div>
    </form>

</div>

</body>
</html>