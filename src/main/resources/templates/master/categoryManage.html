<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품관리페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" >
    <link rel="stylesheet" href="../../static/css/master.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" ></script>
</head>

<body>
  
    <!-- 네비게이션 바 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
          <a class="navbar-brand" href="#">Admin</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                  <li class="nav-item dropdown"><a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown" aria-expanded="false">상품관리</a>
                      <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="../master/productManage.html">상품관리</a></li>
                          <li><a class="dropdown-item" href="../master/categoryManage.html">카테고리 관리</a></li>
                          <li><a class="dropdown-item" href="../master/productUpload.html">상품 등록</a></li>
                        </ul>
                  </li>
                  <li class="nav-item"><a class="nav-link" href="../master/userManage.html">회원관리</a></li>
                  <li class="nav-item"><a class="nav-link" href="../master/deliveryManage.html">배송관리</a></li>
                  <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">문의/리뷰목록</a>
                      <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="../master/qnaList.html">문의 목록</a></li>
                          <li><a class="dropdown-item" href="../master/reviewList.html">리뷰 목록</a></li>
                        </ul>
                  </li>
                  <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">메일관리</a>
                      <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="../master/mailList.html">메일 발송 목록</a></li>
                          <li><a class="dropdown-item" href="../master/mailSend.html">메일 발송</a></li>
                        </ul>
                  </li>
                  <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">쿠폰</a>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="../master/couponMake.html">쿠폰 생성</a></li>
                      <li><a class="dropdown-item" href="../master/couponList.html">생성된 쿠폰 리스트</a></li>
                    </ul>
                  </li>
              </ul>
              <span class="navbar-text">Admin01</span>
          </div>
      </div>
    </nav>
        
    <!-- 카테고리 관리 -->
    <div class="container mt-3">     
      <h3 class="mt-3">카테고리 관리</h3>
      <hr>

      <!-- 카테고리 목록을 1차, 2차, 3차로 나누어 출력 -->
      <div class="row mt-4">
          <!-- 1차 카테고리 -->
          <div class="col-md-4">
              <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                      <li class="breadcrumb-item active" aria-current="page">선택</li>
                  </ol>
              </nav>
              <!-- 1차 카테고리 리스트 -->
              <ul class="list-group">
                  <!-- Thymeleaf 반복문으로 1차 카테고리 출력 -->
                  <li th:each="category : ${categories}" th:text="${category.name}" 
                      th:data-id="${category.id}" 
                      th:onclick="'window.location.href=\'/categories/' + ${category.id} + '/subcategories\' '"
                      class="list-group-item">카테고리 이름
                          <!-- 수정 버튼 -->
                          <button class="btn btn-sm btn-outline-primary" th:onclick="'editCategory(' + ${category.id} + ', \'' + ${category.name} + '\')'">수정</button>
                          <!-- 삭제 버튼 -->
                          <button class="btn btn-sm btn-outline-danger" th:onclick="'deleteCategory(' + ${category.id} + ')'">삭제</button>
                  </li>
              </ul>

              <!-- 1차 카테고리 추가 폼 -->
              <div class="input-group mt-2">
                  <input type="text" id="mainCategory" class="form-control" placeholder="카테고리명을 입력하세요." aria-label="">
                  <button th:onclick="'addCategory(1)'" class="btn btn-outline-secondary">추가</button>
              </div>
          </div>

          <!-- 2차 카테고리 (선택된 1차 카테고리에 대한 하위 카테고리) -->
          <div class="col-md-4">
              <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                      <li th:text="${selectedCategory?.name}" class="breadcrumb-item"></li>
                      <li class="breadcrumb-item active" aria-current="page">선택</li>
                  </ol>
              </nav>

              <!-- 2차 카테고리 리스트 -->
              <ul class="list-group">
                  <!-- 선택된 1차 카테고리에 대한 하위 카테고리를 출력 -->
                  <li th:each="subcategory : ${selectedCategory?.children}" 
                      th:text="${subcategory.name}" 
                      th:data-id="${subcategory.id}"
                      th:onclick="'window.location.href=\'/categories/' + ${subcategory.id} + '/subcategories\' '"
                      class="list-group-item">소 카테고리 이름
                          <!-- 수정 버튼 -->
                          <button class="btn btn-sm btn-outline-primary" th:onclick="'editCategory(' + ${subcategory.id} + ', \'' + ${subcategory.name} + '\')'">수정</button>
                          <!-- 삭제 버튼 -->
                          <button class="btn btn-sm btn-outline-danger" th:onclick="'deleteCategory(' + ${subcategory.id} + ')'">삭제</button>
                  </li>
              </ul>

              <!-- 2차 카테고리 추가 폼 -->
              <div class="input-group mt-2">
                  <input type="text" id="midCategory" class="form-control" placeholder="카테고리명을 입력하세요." aria-label="">
                  <button th:onclick="'addCategory(2)'" class="btn btn-outline-secondary">추가</button>
              </div>  
          </div>

          <!-- 3차 카테고리 (선택된 2차 카테고리에 대한 하위 카테고리) -->
          <div class="col-md-4">
              <nav aria-label="breadcrumb">
                  <ol class="breadcrumb">
                      <li th:text="${selectedCategory?.parent?.name}" class="breadcrumb-item"></li>
                      <li th:text="${selectedCategory?.name}"class= "breadcrumb-item"></li> 
                      <li class= "breadcrumb-item active" aria-current= "page"></li> 
                  </ol> 
              </nav>

              <!-- 3차 카테고리 리스트 -->
              <ul class= "list-group"> 
                  <!-- 선택된 2차 카테고리에 대한 하위 카테고리를 출력 --> 
                  <li th:each= "subSubcategory : ${selectedCategory?.children}" 
                      th:text= "${subSubcategory.name}" 
                      th:data-id= "${subSubcategory.id}"
                      th:onclick= "'window.location.href=\'/categories/' + ${subSubcategory.id} + '/subcategories\' '"
                      class= "list-group-item"> 상세 카테고리 이름
                          <!-- 수정 버튼 -->
                          <button class="btn btn-sm btn-outline-primary" th:onclick="'editCategory(' + ${subSubcategory.id} + ', \'' + ${subSubcategory.name} + '\')'">수정</button>
                          <!-- 삭제 버튼 -->
                          <button class="btn btn-sm btn-outline-danger" th:onclick="'deleteCategory(' + ${subSubcategory.id} + ')'">삭제</button>
                  </li> 
              </ul> 

              <!-- 3차 카테고리 추가 폼 --> 
              <div class= "input-group mt-2"> 
                  <input type= "text" id= "detailCategory" placeholder= "카테고리명을 입력하세요." aria-label="" class= "form-control"/> 
                  <button th:onclick="'addCategory(3)'" type= "button" id= "button-addon2" class= "btn btn-outline-secondary">추가</button> 
              </div>  
          </div>  
      </div>  
  </div> 

<script>
  //카테고리를 추가하는 함수
  function addCategory(level) {
      let categoryName;
      
      if (level === 1) {
          categoryName = document.getElementById("mainCategory").value;
      } else if (level === 2) {
          categoryName = document.getElementById("midCategory").value;
      } else if (level === 3) {
          categoryName = document.getElementById("detailCategory").value;
      }
      
      // Ajax 요청으로 서버에 새로운 카테고리를 추가하는 로직 구현
      fetch('/categories/add', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name: categoryName, level: level })
      }).then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('카테고리 추가에 실패했습니다.');
            }
        });
  }
  
  // 카테고리 수정 함수
  function editCategory(categoryId, currentName) {
      const newName = prompt("새로운 카테고리 이름을 입력하세요:", currentName);
  
      if (!newName || newName.trim() === "" || newName === currentName) {
          alert("변경된 이름이 없습니다.");
          return;
      }
  
      fetch(`/categories/update`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({ id: categoryId, name: newName })
      }).then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('카테고리 수정에 실패했습니다.');
            }
      });
  }
  
  // 카테고리 삭제 함수
  function deleteCategory(categoryId) {
      if (confirm("정말로 이 카테고리를 삭제하시겠습니까?")) {
          fetch(`/categories/delete/${categoryId}`, {
              method: 'DELETE',  // DELETE 메서드 사용
              headers: { 'Content-Type': 'application/json' }
          }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('카테고리 삭제에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('서버와의 통신 중 오류가 발생했습니다.');
            });
      }
  }
  </script>
</body>
</html>