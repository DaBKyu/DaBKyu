<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메일발송페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" >
    <link rel="stylesheet" href="../../static/css/master.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" ></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function(){
            //파일첨부 이벤트
            $('.filebox .upload-hidden').on('change', function(){  			
                if(window.FileReader){
                    var filename = $(this)[0].files[0].name;
                    if(!validFileType(filename)){
                        alert("허용하지 않는 확장자 파일입니다.");
                        return false;
                    }else{
                        if(!validFileSize($(this)[0].files[0])){
                            alert("파일 사이즈가 10MB를 초과합니다.");
                            return false;
                        }else{
                            if(!validFileNameSize(filename)){
                                alert("파일명이 30자를 초과합니다.");
                                return false;
                            }
                        }
                    }
                } else {
                    var filename = $(this).val().split('/').pop().split('\\').pop();
                }
                $(this).prev().val(filename); //input upload-name 에 파일명 설정해주기
    
                readImage($(this)[0]); //미리보기
            });
        });
    
        function validFileType(filename) {
            const fileTypes = ["png", "jpg", "jpeg"];
            return fileTypes.indexOf(filename.substring(filename.lastIndexOf(".")+1, filename.length).toLowerCase()) >= 0;
        }
        
        function validFileSize(file){
            if(file.size > 10000000){ //10MB
                return false;
            }else{
                return true;
            }
        }
    
        function validFileNameSize(filename){
            if(filename.length > 30){ //30자
                return false;
            }else{
                return true;
            }
        }
    
        //이미지 띄우기
        function readImage(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e){
                    const previewImage = document.getElementById("preview");
                    previewImage.src = e.target.result;
                   }
                
                // reader가 이미지 읽도록 하기
                reader.readAsDataURL(input.files[0]);
            }
        }
        // function imageChange(event){
        // let i = event.target.files.length-1;
        // for(let image of event.target.files){
        //     let img = document.createElement("img");
        //     const reader = new FileReader();
        //     reader.onload = function(event){
        //         img.setAttribute("preview", event.target.result);
        //     }
        //     reader.readAsDataURL(event.target.files[i--]);  
        //     document.querySelector(".filebox").appendChild(img);
        // }
    //    }
        
        //이미지 원본 팝업 띄우기
        function popImage(url) {
            var img = new Image();
            img.src = url;
            var img_width = img.width;
            var win_width = img.width + 25;
            var img_height = img.height;
            var win = img.height + 30;
            var popup = window.open('', '_blank', 'width=' + img_width + ', height=' + img_height + ', menubars=no, scrollbars=auto');
            popup.document.write("<style>body{margin:0px;}</style><img src='"+url+"' width='"+win_width+"'>");
        }
    </script>
    <style>
         img#preview{cursor:pointer;max-height:100px; max-width:100%;display:block;}
        .recipient-tag {
            display: inline-block;
            background-color: #e9ecef;
            padding: 0.25rem 0.5rem;
            margin: 0.25rem;
            border-radius: 0.25rem;
        }
        .recipient-tag .close {
            margin-left: 0.5rem;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- 네비게이션 바 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown"><a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown" aria-expanded="false">상품관리</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="../master/productManage.html">상품관리</a></li>
                            <li><a class="dropdown-item" href="../master/categoryManage.html">카테고리 관리</a></li>
                            <li><a class="dropdown-item" href="../master/productUpload.html">상품 등록</a></li>
                          </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="../master/userManage.html">회원관리</a></li>
                    <li class="nav-item"><a class="nav-link" href="../master/deliveryManage.html">배송관리</a></li>
                    <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">문의/리뷰목록</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="../master/qnaList.html">문의 목록</a></li>
                            <li><a class="dropdown-item" href="../master/reviewList.html">리뷰 목록</a></li>
                          </ul>
                    </li>
                    <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">메일관리</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="../master/mailLog.html">메일 발송 목록</a></li>
                            <li><a class="dropdown-item" href="../master/mailSend.html">메일 발송</a></li>
                          </ul>
                    </li>
                    <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">쿠폰</a>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="../master/couponMake.html">쿠폰 생성</a></li>
                        <li><a class="dropdown-item" href="../master/couponList.html">생성된 쿠폰 리스트</a></li>
                      </ul>
                    </li>
                </ul>
                <span class="navbar-text">Admin01</span>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 class="mt-4">메일 발송</h2>

        <form id="mailForm">
            <div class="mb-3">
                <label for="recipients" class="form-label">수신자</label>
                <div id="recipientTags" class="border p-2 rounded">
                    <span class="recipient-tag">김민수 <email@maeil.com><span class="close">&times;</span></span>
                    <!-- 수신자 태그들이 여기에 추가될 공간 -->
                </div>
                <input type="hidden" id="recipients" name="recipients">
            </div>
            <div class="mb-3">
                <label for="subject" class="form-label">제목</label>
                <input type="text" class="form-control" id="subject" name="subject" required>
            </div>
            <div class="mb-3">
                <label for="content" class="form-label">내용</label>
                <textarea class="form-control" id="content" name="content" rows="10" required></textarea>
            </div>
            <div class="mb-3">
                <label for="attachment" class="form-label">파일첨부</label>
                <input type="file" class="form-control" id="attachment" name="attachment">
            </div>
            <div class="d-grid gap-2 d-md-flex justify-content-md-end" role="group">
                <button type="submit" class="btn btn-primary">메일 보내기</button>
                <button type="button" class="btn btn-secondary" onclick="history.back()">작성 취소</button>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        var mailForm = document.getElementById('mailForm');
        var recipientTags = document.getElementById('recipientTags');
        var recipientsInput = document.getElementById('recipients');

        // 서버에서 전달받은 수신자 정보
        var recipients = /*[[${recipients}]]*/ [];

        // 수신자 태그 생성
        recipients.forEach(function(recipient) {
            createRecipientTag(recipient);
        });

        function createRecipientTag(recipient) {
            var tag = document.createElement('span');
            tag.className = 'recipient-tag';
            tag.innerHTML = `${recipient.name} <${recipient.email}> <span class="close">&times;</span>`;
            tag.querySelector('.close').addEventListener('click', function() {
                tag.remove();
                updateRecipientsInput();
            });
            recipientTags.appendChild(tag);
        }

        function updateRecipientsInput() {
            var emails = Array.from(recipientTags.querySelectorAll('.recipient-tag'))
                              .map(tag => tag.textContent.match(/<(.+?)>/)[1]);
            recipientsInput.value = emails.join(',');
        }

        updateRecipientsInput();

        mailForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMail();
        });
    });

    function sendMail() {
        var formData = new FormData(document.getElementById('mailForm'));

        fetch('/api/send-mail', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('메일 발송 성공:', data);
            alert('메일이 성공적으로 발송되었습니다.');
            window.location.href = '/user-management';
        })
        .catch((error) => {
            console.error('메일 발송 실패:', error);
            alert('메일 발송에 실패했습니다. 다시 시도해 주세요.');
        });
    }
    </script>
</body>
</html>

<!-- 백엔드 예시사항
List<Map<String, String>> recipients = selectedUsers.stream()
    .map(user -> Map.of("name", user.getName(), "email", user.getEmail()))
    .collect(Collectors.toList());
model.addAttribute("recipients", recipients);
-->