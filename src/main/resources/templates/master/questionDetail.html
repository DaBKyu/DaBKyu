<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문의 답변 페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" >
    <link rel="stylesheet" href="../static/css/master.css" th:href="@{/css/master.css}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" ></script>
    <script>
        const submitReply = async () => {
        const content = document.querySelector('#comContent');
        const queSeqno = document.querySelector('#queSeqno').value;
        const email = document.querySelector('#email').value;

        if (content.value === '') {
            alert('답변을 입력하세요.');
            content.focus();
            return false;
        }

        const formData = new FormData();
        formData.append("comContent", content.value);
        formData.append("queSeqno", queSeqno);
        formData.append("email", email);

        try {
            const response = await fetch('/master/reply?option=I', {
                method: 'POST',
                body: formData,
            });

            if (response.ok) {
                const data = await response.json();
                alert(data.message);

                // 답변 내용을 readonly로 변경
                content.setAttribute('readonly', true);

                // "수정" 버튼 활성화
                document.querySelector('#editBtn').classList.remove('d-none');
                document.querySelector('#submitBtn').classList.add('d-none');
            } else {
                throw new Error('답변 등록 실패');
            }
            } catch (error) {
                console.error('Error:', error);
                alert("시스템 장애로 답변 등록이 실패했습니다.");
            }
        };
        const enableEdit = () => {
            const content = document.querySelector('#comContent');

            // readonly 해제
            content.removeAttribute('readonly');

            // "답변 제출" 버튼 활성화
            document.querySelector('#submitBtn').classList.remove('d-none');
            document.querySelector('#editBtn').classList.add('d-none');
        };
        const updateReply = async () => {
            const content = document.querySelector('#comContent');
            const queSeqno = document.querySelector('#queSeqno').value;
            const email = document.querySelector('#email').value;

            if (content.value === '') {
                alert('내용을 입력하세요.');
                content.focus();
                return false;
            }

            const formData = new FormData();
            formData.append("comContent", content.value);
            formData.append("queSeqno", queSeqno);
            formData.append("email", email);

            try {
                const response = await fetch('/master/reply?option=U', {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);

                    // 다시 readonly로 변경
                    content.setAttribute('readonly', true);

                    // "수정" 버튼 활성화
                    document.querySelector('#editBtn').classList.remove('d-none');
                    document.querySelector('#submitBtn').classList.add('d-none');
                } else {
                    throw new Error('답변 수정 실패');
                }
            } catch (error) {
                console.error('Error:', error);
                alert("시스템 장애로 답변 수정이 실패했습니다.");
            }
        };

        const deleteQuestion = async () => {
            const queSeqno = document.querySelector('#queSeqno').value;

            if (!confirm('정말로 이 문의를 삭제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`/master/question/delete?queSeqno=${queSeqno}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    alert('문의가 성공적으로 삭제되었습니다.');
                    window.location.href = '/master/question'; // 목록 페이지로 리다이렉트
                } else if (response.status === 404) {
                    alert('해당 문의를 찾을 수 없습니다.');
                } else {
                    alert('문의 삭제 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('시스템 장애로 문의 삭제가 실패했습니다.');
            }
        };
    </script>
</head>
<body>

    <!-- 네비게이션 바 -->
    <div th:insert="~{layout/masterNav :: master-nav}"></div>

<div class="container mt-5">
    <h2>문의 답변 페이지</h2>

    <!-- 문의 정보 표시 -->
    <div class="card mb-4">
        <div class="card-body">
            <p class="card-text"><small class="text-muted">작성자: <span th:text="${question['email'].email}"></span></small></p>
            <p class="card-text"><small class="text-muted">작성일: <span th:text="${#temporals.format(question['queDate'], 'yyyy-MM-dd HH:mm')}"></span></small></p>
            <h5 class="card-title">문의 제목: <span th:text="${question['queTitle']}"></span></h5>
            <p class="card-text">문의 내용:</p>
            <p th:text="${question['queContent']}"></p>
        </div>
    </div>

    <!-- 첨부  -->
    <div th:if="${#lists.size(questionFiles) > 0}">
        <h5>첨부 파일</h5>
        <ul>
            <li th:each="file : ${questionFiles}">
                <a th:href="@{'/q_img/' + ${file.org_filename}}" target="_blank" th:text="${file.stored_filename}"></a>
            </li>
        </ul>
    </div>
    <div class="mb-3">
        <button type="button" class="btn btn-danger" onclick="deleteQuestion()">문의 삭제</button>
        <!-- 작성중 페이지로 돌아가기 버튼 -->
        <button type="button" class="btn btn-secondary" onclick='window.history.back()'>돌아가기</button>
    </div>

    <!-- 답변 작성 폼 -->
    <form id="replyForm" name="replyForm" method="post">
        <!-- 답변 입력란 -->
        <div class="mb-3">
            <label for="comContent" class="form-label">답변 내용:</label>
            <textarea class="form-control" id="comContent" name="comContent" rows="5"></textarea>
            <input type="hidden" id="queSeqno" name="queSeqno" th:value="${question['queSeqno']}">
            <input type="hidden" id="email" name="email" th:value="${question['email'].email}">
        </div>
        <div>
            <button id="submitBtn" type="button" class="btn btn-primary" onclick="submitReply()">답변 제출</button>
            <button id="editBtn" type="button" class="btn btn-secondary d-none" onclick="enableEdit()">수정</button>
        </div>
    </form>

</div>

</body>
</html>