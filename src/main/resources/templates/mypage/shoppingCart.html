<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
				xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="UTF-8">
<title>장바구니</title>
<link rel="stylesheet" type="text/css" href="/css/shopHeader.css">
<style>

.tableDiv {
text-align: center;
}

.InfoTable {
	border-collapse: collapse;
	border-top: 3px solid #168;
	width: 85%;  
	margin-left: auto; margin-right: auto;
}  
.InfoTable th {
	color: #168;
	background: #f0f6f9;
	text-align: center;
}
.InfoTable th, .InfoTable td {
	padding: 10px;
	border: 1px solid #ddd;
}
.InfoTable th:first-child, .InfoTable td:first-child {
	border-left: 0;
}
.InfoTable th:last-child, .InfoTable td:last-child {
	border-right: 0;
}
.InfoTable tr td:first-child{
	text-align: center;
}
.InfoTable caption{caption-side: top; }

.p_image {
	max-width: 30%;
	height: auto;
	margin: auto;
}

.btn_cart  {
width:150px;
height:40px;
background: #168;
color:white;
font-weight: bold;
border:none;
cursor:pointer;

}

</style>
<script>
	//전역변수 초기화
	var email = '[[${session.email}]]';
	var totalItemAmount = 0;


	//상품별 상품 가격 계산
	const count = (type,priceId,quantityId,amountId,orderProductSeqno) =>  {
		console.log('priceId:', priceId); // 확인용 로그
		console.log('quantityId:', quantityId); // 확인용 로그
		console.log('amountId:', amountId); // 확인용 로그
		console.log('orderProductSeqno:', orderProductSeqno); // 확인용 로그

		let amount = parseInt(document.getElementById(amountId).innerHTML.replace(/,/g, ""));
		let price = parseInt(document.getElementById(priceId).innerHTML.replace(/,/g, ""));
		let quantity = parseInt(document.getElementById(quantityId).innerHTML);

		if(type === 'plus') {
			quantity += 1;
			amount += price;
			quantityUpdate(orderProductSeqno,quantity);  
		} else if(type === 'minus' && quantity !==1)  {
			quantity -= 1;
			amount -= price;
			quantityUpdate(orderProductSeqno,quantity);
		}
		document.getElementById(quantityId).innerHTML = quantity.toLocaleString('ko-KR');
		document.getElementById(amountId).innerHTML = amount.toLocaleString('ko-KR');
		//document.getElementById('selectedAmount').innerHTML = totalItemAmount.toLocaleString('ko-KR');
		//cal_totalAmount();

	}

	//상품 갯수 변경 업데이트
	const quantityUpdate = async (orderProductSeqno,quantity) => {
		console.log("갯수 수정 시작");

		await fetch('/mypage/shoppingCart?kind=U',{
			method: "POST",
			headers: {
				"Content-Type": "application/json",
			},
			body: JSON.stringify({
				email : email,
				orderProductSeqno : orderProductSeqno,
				amount : quantity
			}),
		}).then((response) => response.text())
		.then((data) => {
			if(data == null || data == '')
				alert("시스템 장애로 상품 수량변경이 실패했습니다.");
		}).catch((error) => console.log("error = " + error));

	}
	
	
</script>

<!--<script src="/js/logout.js"></script>-->

</head>
<!--<body onload = "cal_totalAmount()">-->
<body>
<!-- 로그인 여부 확인 -->
<script>
	//let email = '[[${session.email}]]';
	if(email == '' || email == null || email == undefined)
		document.location.href = '/member/login';
</script>
<th:block th:replace="~{layout/shopHeader::header}"></th:block>
<div class="mall">
	<div class="main_shop">
		<div class="tableDiv">
			<h1>[[${session.username}]]님의 장바구니</h1>
			<br><br>
			<table class="InfoTable">
				<thead>
					<tr>
						<th>제품이미지</th>
						<th>제품명</th>
						<th>제품단가</th>
						<th>제품갯수</th>
						<th>제품가격</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="orderProduct : ${list}">
						<td><img th:src="@{/shop/product/{imageName}(imageName=${orderProduct.orderProductSeqno.productSeqno.infoStoredImage})}"
								 style="width: 100px; height: 70px;">
						</td>
						<td><a th:href="@{'/shop/view?productSeqno=' + ${orderProduct.orderProductSeqno.productSeqno.productSeqno}} + '&page=1'">
							<span th:text="${orderProduct.orderProductSeqno.productSeqno.productName}"></span>
							</a>
						</td>

						<th:block th:if="${orderProduct.orderProductSeqno.productSeqno.stockAmount} lt 1">
			  				<td><span th:id="${'p' + orderProduct.orderProductSeqno}">0</span>원</td>
			  			</th:block>

						<th:block th:if="${orderProduct.orderProductSeqno.productSeqno.stockAmount} gt 0">
							<td><span th:id="${'p' + orderProduct.orderProductSeqno}">[[${#numbers.formatInteger(orderProduct.orderProductSeqno.productSeqno.price,3,'COMMA')}]]</span>원</td>
						</th:block>
						
						<td><input type='button' th:onclick='count("plus",[[${"p" + orderProduct.orderProductSeqno.orderProductSeqno}]],[[${"q"+ orderProduct.orderProductSeqno.orderProductSeqno}]],[[${"a" + orderProduct.orderProductSeqno.orderProductSeqno}]],[[${orderProduct.orderProductSeqno.orderProductSeqno}]])' value='+' th:disabled="${orderProduct.orderProductSeqno.productSeqno.stockAmount} lt 1">
							<span th:id="${'q' + orderProduct.orderProductSeqno}">[[${orderProduct.orderProductSeqno.amount}]]</span>
							<input type='button' th:onclick='count("minus",[[${"p" + orderProduct.orderProductSeqno.orderProductSeqno}]],[[${"q"+ orderProduct.orderProductSeqno.orderProductSeqno}]],[[${"a" + orderProduct.orderProductSeqno.orderProductSeqno}]],[[${orderProduct.orderProductSeqno.orderProductSeqno}]])' value='-' th:disabled="${orderProduct.orderProductSeqno.productSeqno.stockAmount} lt 1">
						</td>
						<th:block th:if="${orderProduct.orderProductSeqno.productSeqno.stockAmount} lt 1">
							<td><span class="cartAmount" th:id="${'a' + orderProduct.orderProductSeqno.orderProductSeqno}">0</span>원</td>
						</th:block>
						<th:block th:if="${orderProduct.orderProductSeqno.productSeqno.stockAmount} gt 0">
							<td><span class="cartAmount" 
								th:id="${'a' + orderProduct.orderProductSeqno.orderProductSeqno}" 
								th:text="${#numbers.formatInteger(orderProduct.orderProductSeqno.amount * orderProduct.orderProductSeqno.productSeqno.price, 3, 'COMMA')}">
					  		</span>원</td>
						</th:block>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>
</body>
</html>

